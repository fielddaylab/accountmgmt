<html>
<head>
<link href="https://fonts.googleapis.com/css?family=Open+Sans:200,300,400,700" rel="stylesheet">
<style>
body,div,span
{
  margin:0px;
  padding:0px;
  color:blue;
  font:16px Open Sans;
}
img
{
  display:block;
}
body
{
  background-color:#444444;
}
td
{
  text-align:right;
}
.spacer
{

}
#middle_bar
{
  margin:0px auto;
  width:500px;
  height:100%;
  background-color:white;
}
#content
{

}
#brand
{

}
#tabs
{
  padding:10px;
}
.tab
{
  float:left;
  padding:2px 5px 0px 5px;
  border-top-left-radius:10px;
  border-top-right-radius:10px;
}
#sections
{
  clear:both;
  width:100%;
}
.section
{
  display:none;
  padding:10px;
}
.button
{
  margin:0px auto;
  width:50%;
  padding:8px;
  border:2px solid blue;
  border-radius:20px;
  text-align:center;
}
#alert
{
  display:none;
  width:200px;
  padding:20px;
  background-color:white;
  border:2px solid blue;
  border-radius:20px;
  margin:0px auto;
  position:absolute;
  top:50px;
}
#alert_txt
{

}
#alert_dismiss
{
  text-align:center;
}

</style>

<script type="text/javascript">
function load()
{
  displaySection("auth");
  var params = parseURLParams(document.URL);
  if(params.username && params.password)
  {
    document.getElementById('auth_request_user').value = params.username;
    document.getElementById('auth_request_password').value = params.password;
    submitAuth();
  }
}

function displaySection(section)
{
  document.getElementById("auth_tab").style.borderTop       = "2px solid white";
  document.getElementById("auth_tab").style.borderLeft      = "2px solid white";
  document.getElementById("auth_tab").style.borderRight     = "2px solid white";
  document.getElementById("create_tab").style.borderTop     = "2px solid white";
  document.getElementById("create_tab").style.borderLeft    = "2px solid white";
  document.getElementById("create_tab").style.borderRight   = "2px solid white";
  document.getElementById("change_tab").style.borderTop     = "2px solid white";
  document.getElementById("change_tab").style.borderLeft    = "2px solid white";
  document.getElementById("change_tab").style.borderRight   = "2px solid white";
  document.getElementById("reset_tab").style.borderTop      = "2px solid white";
  document.getElementById("reset_tab").style.borderLeft     = "2px solid white";
  document.getElementById("reset_tab").style.borderRight    = "2px solid white";
  document.getElementById(section+"_tab").style.borderTop   = "2px solid blue";
  document.getElementById(section+"_tab").style.borderLeft  = "2px solid blue";
  document.getElementById(section+"_tab").style.borderRight = "2px solid blue";

  document.getElementById("auth_section").style.display     = "none";
  document.getElementById("create_section").style.display   = "none";
  document.getElementById("change_section").style.display   = "none";
  document.getElementById("reset_section").style.display    = "none";
  document.getElementById(section+"_section").style.display = "block";
}

function displayAlert(txt)
{
  document.getElementById("alert_txt").innerHTML = txt;
  document.getElementById("alert").style.display = "block";
}
function dismissAlert()
{
  document.getElementById("alert_txt").innerHTML = "";
  document.getElementById("alert").style.display = "none";
}

function parseURLParams(url) 
{
  var queryStart = url.indexOf("?") + 1;
  var queryEnd   = url.indexOf("#") + 1 || url.length + 1;
  var query      = url.slice(queryStart, queryEnd - 1);

  var params  = {};
  if (query === url || query === "") return params;
  var nvPairs = query.replace(/\+/g, " ").split("&");

  for(var i=0; i<nvPairs.length; i++)
  {
    var nv = nvPairs[i].split("=");
    var n  = decodeURIComponent(nv[0]);
    var v  = decodeURIComponent(nv[1]);
    if(!(n in params)) params[n] = [];
    params[n].push(nv.length === 2 ? v : null);
  }
  return params;
}

function sendRequest(fn, params, method)
{
  var xmlhttp;
  xmlhttp=new XMLHttpRequest();
  xmlhttp.open(method,"http://www.arisgames.org/server/json.php/v2."+fn,false);
  xmlhttp.setRequestHeader("Content-type", "application/json");
  xmlhttp.send(params); //Synchronous call

  return JSON.parse(xmlhttp.responseText);
}

function submitAuth()
{
  var username = document.getElementById('auth_request_user').value;
  var password = document.getElementById('auth_request_password').value;

  if(username.length < 3)
  { displayAlert("Please enter a username with at least 5 characters."); return; }
  if(!username.match(/^[A-Za-z0-9_]*$/))
  { displayAlert("Please enter a username using only letters, numbers, or _."); return; }
  if(password.length < 3)
  { displayAlert("Please enter a valid password."); return; }

  var package = {"user_name":username,"password":password,"permission":"read_write"};
  var response = sendRequest('users.logIn', JSON.stringify(package), "POST");
  console.log(response);
  if(response.returnCode) displayAlert("Either the user does not exist, or you have entered the wrong password.");
  else                    displayAlert("User account "+username+" confirmed!");
}

function submitCreate()
{
  var username         = document.getElementById('create_request_user').value;
  var password         = document.getElementById('create_request_password').value;
  var password_confirm = document.getElementById('create_request_password_confirm').value;
  var email            = document.getElementById('create_request_email').value;

  if(username.length < 3)
  { displayAlert("Please enter a username with at least 5 characters."); return; }
  if(!username.match(/^[A-Za-z0-9_]*$/))
  { displayAlert("Please enter a username using only letters, numbers, or _."); return; }
  if(password.length < 3)
  { displayAlert("Please enter a valid password."); return; }
  if(password != password_confirm)
  { displayAlert("Passwords don't match."); return; }

  var package = {"user_name":username,"password":password,"email":email};
  var response = sendRequest('users.createUser', JSON.stringify(package), "POST");
  console.log(response);
  if(response.returnCode) displayAlert("Something went wrong: "+response.returnCodeDescription);
  else                    displayAlert("User account "+username+" created!");
}

function submitChange()
{
  var username             = document.getElementById('change_request_user').value;
  var password             = document.getElementById('change_request_password_old').value;
  var password_new         = document.getElementById('change_request_password_new').value;
  var password_new_confirm = document.getElementById('change_request_password_new_confirm').value;

  if(username.length < 3)
  { displayAlert("Please enter a username with at least 5 characters."); return; }
  if(!username.match(/^[A-Za-z0-9_]*$/))
  { displayAlert("Please enter a username using only letters, numbers, or _."); return; }
  if(password.length < 3)
  { displayAlert("Please enter a valid password."); return; }

  if(password_new.length < 3)
  { displayAlert("Please enter a valid password."); return; }
  if(password_new != password_new_confirm)
  { displayAlert("Passwords don't match."); return; }

  var package = {"user_name":username,"old_password":password,"new_password":password_new};
  var response = sendRequest('users.changePassword', JSON.stringify(package), "POST");
  console.log(response);
  if(response.returnCode) displayAlert("Something went wrong: "+response.returnCodeDescription);
  else                    displayAlert("Password successfully changed!");
}

function submitReset()
{
  var username = document.getElementById('reset_request_user').value;
  var email    = document.getElementById('reset_request_email').value;

  var username_valid = false;
  var email_valid = false;

  if(username.length > 3 && username.match(/^[A-Za-z0-9_]*$/)           ) username_valid = true;
  if(email.length    > 3 && email.match(/^[A-Za-z0-9_]*@[A-Za-z0-9_]*$/)) email_valid    = true; //incredibly basic email verification

  if(username.length > 0 && !username_valid)
  { displayAlert("Enter a valid username."); return; }
  if(email.length > 0 && !email_valid)
  { displayAlert("Enter a valid email."); return; }
  if(!username_valid && !email_valid)
  { displayAlert("Enter a valid username or email."); return; }

  var package;
  if(username_valid) package = {"user_name":username};
  if(email_valid)    package = {"user_name":"","email":email};
  var response = sendRequest('users.requestForgotPasswordEmail', JSON.stringify(package), "POST");
  console.log(response);
  if(response.returnCode) displayAlert("Something went wrong: "+response.returnCodeDescription);
  else                    displayAlert("If an account exists with these credentials, an email has been sent to its corresponding address with the next steps.");
}


/* NEEDS INTEGRATION
   function submitFix()
   {
   var p = parseURLParams(window.location.href);
   var p1 = document.getElementById('p1').value;
   var p2 = document.getElementById('p2').value;
   if(p1 != p2) {
   errorAlert("Passwords do not match.");
   return;
   }

   if(p1 === "") {
   warningAlert("Password can't be blank.");
   return;
   }

   var response = sendRequest('v2.users.fixPassword', {"user_id":p.i[0],"junk":p.j[0],"new_password":p1}, "POST");
   console.log(response);
   document.getElementById("content-area").innerHTML = "<h4>Your password was reset! Close this window and head back to ARIS to log in.</h4>";
   }

   function errorAlert(message) {
   document.getElementById('alert-box').innerHTML = "<div class='alert alert-danger' role='alert'><span class='glyphicon glyphicon-remove'></span> "+message+"</div>"
   }

   function warningAlert(message) {
   document.getElementById('alert-box').innerHTML = "<div class='alert alert-warning' role='alert'><span class='glyphicon glyphicon-question-sign'></span> "+message+"</div>"
   }
 */
</script>
</head>
<body onload="load()">

<div id="middle_bar">

  <div class="spacer" style="height:10%;"></div>
  <div id="content">

    <div id="brand">
      <img src="assets/arrow.png" style="margin:0px auto; width:10%;"></img>
      <div class="spacer" style="height:20px;"></div>
      <img src="assets/logo.png" style="margin:0px auto; width:80%;"></img>
    </div>

    <div class="spacer" style="height:30px;"></div>

    <div id="tabs">
      <div class="tab" id="auth_tab"   onclick='displaySection("auth")'  > Confirm Account </div>
      <div class="tab" id="create_tab" onclick='displaySection("create")'> Create Account  </div>
      <div class="tab" id="change_tab" onclick='displaySection("change")'> Change Password </div>
      <div class="tab" id="reset_tab"  onclick='displaySection("reset")' > Forgot Password?</div>
    </div>

    <div class="spacer" style="height:70px;"></div>

    <div id="sections">

      <div class="section" id="auth_section">
          <table id="auth_inputs">
            <tr> <td>Username:</td> <td><input id="auth_request_user"     type='text'>    </input></td>  </tr>
            <tr> <td>Password:</td> <td><input id="auth_request_password" type='password'></input></td>  </tr>
          </table>
          <div class="spacer" style="height:30px;"></div>
          <div class="button" id="auth_request_submit" onclick='submitAuth()'>SIGN IN</div>
      </div>

      <div class="section" id="create_section">
          <table id="create_inputs">
            <tr> <td>Username:          </td> <td><input id="create_request_user"             type='text'>    </input></td>  </tr>
            <tr> <td>Password:          </td> <td><input id="create_request_password"         type='password'></input></td>  </tr>
            <tr> <td>Password (Confirm):</td> <td><input id="create_request_password_confirm" type='password'></input></td>  </tr>
            <tr> <td>Email (Optional):  </td> <td><input id="create_request_email"            type='text'>    </input></td>  </tr>
          </table>
          <div class="spacer" style="height:30px;"></div>
          <div class="button" id="create_request_submit" onclick='submitCreate()'>CREATE ACCOUNT</div>
      </div>

      <div class="section" id="change_section">
          <table id="change_inputs">
            <tr> <td>Username:          </td> <td><input id="change_request_user"                 type='text'>    </input></td> </tr>
            <tr> <td>Password (Old):    </td> <td><input id="change_request_password_old"         type='password'></input></td> </tr>
            <tr> <td> -                 </td> <td>                                                                        </td> </tr>
            <tr> <td>Password (New):    </td> <td><input id="change_request_password_new"         type='password'></input></td> </tr>
            <tr> <td>Password (Confirm):</td> <td><input id="change_request_password_new_confirm" type='password'></input></td> </tr>
          </table>
          <div class="spacer" style="height:30px;"></div>
          <div class="button" id="change_request_submit" onclick='submitChange()'>CHANGE PASSWORD</div>
      </div>

      <div class="section" id="reset_section">
          <table id="reset_inputs">
            <tr> <td>Username:</td> <td><input id="reset_request_user"  type='text'></input></td> </tr>
            <tr> <td> or      </td> <td>                                                     </td> </tr>
            <tr> <td>Email:   </td> <td><input id="reset_request_email" type='text'></input></td> </tr>
          </table>
          <div class="spacer" style="height:30px;"></div>
          <div class="button" id="reset_request_submit" onclick='submitReset()'>SEND EMAIL</div>
      </div>

    </div>

  </div>

</div>

<div id="alert" onclick='dismissAlert()'>
  <div id="alert_txt"></div>
  <div class="spacer" style="height:10px;"></div>
  <div id="alert_dismiss">(Click to dismiss)</div>
</div>

</body>
</html>

